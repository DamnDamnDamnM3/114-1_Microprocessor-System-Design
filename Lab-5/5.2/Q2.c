/*
 * ================================================================
 * Lab 5.2 - Question 2: 數值顯示與位元操作系統
 * 功能：實作數值的二進制顯示、位元操作和不同進制轉換
 * 硬體：NUC100系列微控制器
 * 作者：damnm3@googlegroups.com 共同作者
 * ================================================================
 *
 * 硬體連接：
 * - PA0,1,2,3,4,5 連接至3x3按鍵矩陣
 * - LCD顯示器連接
 * - PC4,5,6,7 連接至七段顯示器位選
 * - PE0-7 連接至七段顯示器段選
 *
 * 功能說明：
 * 1. 在LCD上顯示數值的二進制表示
 * 2. 在七段顯示器上顯示數值
 * 3. 支援三種顯示模式：無符號整數(U)、有符號整數(S)、十六進制(X)
 * 4. 支援位元操作：左移、右移、清零
 * 5. 支援隨機數產生
 *
 * 按鍵對應：
 * - 按鍵1: 右移並設最高位為1 (>>1|0x80)
 * - 按鍵3: 左移並設最低位為1 (<<1|0x01)
 * - 按鍵4: 右移 (>>1)
 * - 按鍵5: 清零 (設為0)
 * - 按鍵6: 左移 (<<1)
 * - 按鍵7: 無符號整數模式 (U)
 * - 按鍵8: 有符號整數模式 (S)
 * - 按鍵9: 十六進制模式 (X)
 * - 按鍵2: 產生隨機數
 */

// 包含必要的標頭檔
#include <stdio.h>              // 標準輸入輸出函數
#include <stdlib.h>             // 標準函數庫
#include "NUC100Series.h"       // NUC100系列微控制器定義
#include "MCU_init.h"          // 微控制器初始化函數
#include "SYS_init.h"          // 系統初始化函數
#include "LCD.h"                // LCD顯示器控制函數
#include "Scankey.h"           // 按鍵掃描函數
#include "Seven_Segment.h"      // 七段顯示器控制函數

// ================================================================
// 常數定義
// ================================================================
#define MINUS_CODE 16           // 負號"-"的顯示代碼
#define SEG_BLANK 0xFF          // 空白顯示代碼

/*
 * ================================================================
 * 二進制字串轉換函數
 * 功能：將8位元數值轉換為二進制字串格式
 * 參數：out - 輸出字串, v - 要轉換的數值
 * ================================================================
 */
static void bin_str(char* out, unsigned char v){
    int i;
    out[0]='0'; out[1]='b';     // 添加"0b"前綴
    // 從最高位開始處理每一位元
    for(i=0;i<8;i++) out[2+i] = (v & (1<<(7-i)))? '1':'0';
    out[10]='\0';               // 字串結尾
}

/*
 * ================================================================
 * LCD二進制顯示函數
 * 功能：在LCD上顯示數值的二進制表示
 * 參數：N - 要顯示的8位元數值
 * ================================================================
 */
static void lcd_show_bin(unsigned char N){
    char line[17];
    int i;
    char b[11];
    
    // 初始化顯示行
    for(i=0;i<16;i++) line[i]=' ';
    line[16]='\0';
    
    // 轉換為二進制字串
    bin_str(b,N);
    
    // 將二進制字串放入顯示行
    for(i=0;i<10;i++) line[3+i]=b[i];
    
    // 在LCD第1行顯示
    print_Line(1, line);
}

// ================================================================
// 全域變數
// ================================================================
static unsigned char dig[4]={0,0,0,0};    // 七段顯示器數字陣列
static unsigned char mask[4]={0,0,0,0};   // 七段顯示器遮罩陣列

/*
 * ================================================================
 * 無符號整數轉換函數
 * 功能：將無符號整數轉換為七段顯示器格式
 * 參數：v - 要轉換的無符號整數
 * ================================================================
 */
static void make_digits_U(unsigned int v){
    int i;
    
    // 初始化所有數字和遮罩
    for(i=0;i<4;i++){ dig[i]=0; mask[i]=0; }
    
    // 處理0的特殊情況
    if(v==0){
        dig[0]=0; dig[1]=0; mask[0]=1; mask[1]=1;
        return;
    }
    
    // 從個位數開始轉換
    dig[0]=(unsigned char)(v%10); mask[0]=1; v/=10;
    if(v>0){ dig[1]=(unsigned char)(v%10); mask[1]=1; v/=10; }
    if(v>0){ dig[2]=(unsigned char)(v%10); mask[2]=1; v/=10; }
    if(v>0){ dig[3]=(unsigned char)(v%10); mask[3]=1; }
}

/*
 * ================================================================
 * 有符號整數轉換函數
 * 功能：將有符號整數轉換為七段顯示器格式
 * 參數：val - 要轉換的有符號整數
 * ================================================================
 */
static void make_digits_S(int val){
    int neg = (val < 0);                    // 檢查是否為負數
    unsigned int a = (unsigned int)(neg ? -val : val); // 取得絕對值
    int i, idx;
    
    // 初始化所有數字和遮罩
    for(i=0;i<4;i++){ dig[i]=0; mask[i]=0; }
    
    if(!neg){
        // 正數處理
        if(a==0){
            dig[0]=0; dig[1]=0; mask[0]=1; mask[1]=1;
            return;
        }
        idx = 0;
        while(a>0 && idx<4){
            dig[idx] = a % 10;
            mask[idx]=1;
            a/=10;
            idx++;
        }
    }else{
        // 負數處理，顯示負號
        if(a >= 100){
            dig[3]=MINUS_CODE; mask[3]=1;
            dig[2]=(a/100)%10; mask[2]=1;
            dig[1]=(a/10)%10; mask[1]=1;
            dig[0]=a%10; mask[0]=1;
        }else if(a >=10){
            dig[2]=MINUS_CODE; mask[2]=1;
            dig[1]=a/10; mask[1]=1;
            dig[0]=a%10; mask[0]=1;
        }else{
            dig[1]=MINUS_CODE; mask[1]=1;
            dig[0]=a; mask[0]=1;
        }
    }
}

/*
 * ================================================================
 * 十六進制轉換函數
 * 功能：將8位元數值轉換為十六進制顯示格式
 * 參數：v - 要轉換的8位元數值
 * ================================================================
 */
static void make_digits_X(unsigned char v){
    int i;
    
    // 初始化所有數字和遮罩
    for(i=0;i<4;i++){ dig[i]=0; mask[i]=0; }
    
    // 提取低4位和高4位
    dig[0]=(unsigned char)(v & 0x0F);      // 低4位
    dig[1]=(unsigned char)((v>>4) & 0x0F); // 高4位
    mask[0]=1; mask[1]=1;                 // 啟用兩個數字
}

/*
 * ================================================================
 * 七段顯示器刷新函數
 * 功能：刷新七段顯示器顯示
 * ================================================================
 */
static void refresh_once(void){
    int i;
    
    // 依序顯示4個數字
    for(i=0;i<4;i++){
        CloseSevenSegment();               // 關閉所有顯示器
        
        if(mask[i]){
            // 有遮罩，顯示對應數字
            ShowSevenSegment(i, dig[i]);
        }else{
            // 無遮罩，顯示空白
            // 注意：直接設定PE腳位，不透過ShowSevenSegment
            PE->DOUT = SEG_BLANK;
        }
        CLK_SysTickDelay(1000);            // 短暫延遲
    }
}

/*
 * ================================================================
 * 主程式
 * 功能：系統初始化和主迴圈，實作數值顯示與位元操作
 * ================================================================
 */
int main(void){
    unsigned char N=0, mode=0;             // 數值和顯示模式
    unsigned char k=0, prev_k=0;           // 當前和上次按鍵
    unsigned char prev_mode=255, prev_N=255; // 上次模式和數值
    
    // ================================================================
    // 系統初始化
    // ================================================================
    SYS_Init();                            // 系統初始化
    init_LCD();                            // 初始化LCD
    clear_LCD();                           // 清除LCD
    OpenKeyPad();                          // 初始化按鍵矩陣
    CloseSevenSegment();                   // 關閉七段顯示器
    
    // 初始顯示
    lcd_show_bin(N);                       // 顯示初始數值的二進制
    make_digits_U(N);                      // 設定為無符號整數模式
    
    // ================================================================
    // 主程式迴圈
    // ================================================================
    while(1){
        k = ScanKey();                     // 掃描按鍵
        
        // ================================================================
        // 按鍵處理
        // ================================================================
        
        // R鍵：產生隨機數
        if(prev_k==2 && k==0){
            N=(unsigned char)(rand()&0xFF);
        }
        
        // 按鍵按下處理
        if(prev_k==0 && k!=0){
            if(k==1) N=(unsigned char)((N>>1)|0x80); // 右移並設最高位為1
            else if(k==3) N=(unsigned char)((N<<1)|0x01); // 左移並設最低位為1
            else if(k==4) N=(unsigned char)(N>>1); // 右移
            else if(k==6) N=(unsigned char)(N<<1); // 左移
            else if(k==5) N=0; // 清零
            else if(k==7) mode=0; // 無符號整數模式 (U)
            else if(k==8) mode=1; // 有符號整數模式 (S)
            else if(k==9) mode=2; // 十六進制模式 (X)
        }
        
        // ================================================================
        // 顯示更新
        // ================================================================
        
        // 如果N或模式改變，更新LCD和七段顯示器
        if(N!=prev_N || mode!=prev_mode){
            lcd_show_bin(N);               // 更新LCD二進制顯示
            
            // 根據模式轉換數值
            if(mode==0) make_digits_U(N);           // 無符號整數
            else if(mode==1) make_digits_S((signed char)N); // 有符號整數
            else make_digits_X(N);                  // 十六進制
            
            prev_N=N; prev_mode=mode;       // 記錄當前狀態
        }
        
        refresh_once();                     // 刷新七段顯示器
        prev_k=k;                           // 記錄當前按鍵
    }
}