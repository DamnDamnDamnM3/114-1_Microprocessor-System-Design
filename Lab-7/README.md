# Lab 7 - 球體動畫系統與碰撞遊戲

## 📋 實驗概述

Lab 7 包含兩個子實驗，分別實作單向移動球體系統和彈跳球體與目標方塊碰撞遊戲。這些實驗整合了LCD顯示、2D繪圖、按鍵控制和蜂鳴器，展示了嵌入式系統中的動畫和遊戲開發技術。

## 🔧 硬體環境

- **微控制器**: NUC100系列
- **開發板**: Nu-LB-NUC140開發板
- **主要週邊**: LCD顯示器（128x64）、蜂鳴器、3x3按鍵矩陣

## 🔌 硬體連接

### 通用連接
- **PA0,1,2,3,4,5**: 連接至3x3按鍵矩陣
- **PB11**: 連接至蜂鳴器（低電位觸發）
- **LCD顯示器**: 128x64像素圖形LCD，透過SPI連接

### 按鍵矩陣連接
```
按鍵矩陣    →    GPIO腳位
Row 0      →    PA0
Row 1      →    PA1  
Row 2      →    PA2
Col 0      →    PA3
Col 1      →    PA4
Col 2      →    PA5
```

### 蜂鳴器連接
```
蜂鳴器      →    GPIO腳位    功能
控制腳      →    PB11       蜂鳴器控制（Active-Low）
```

## 📁 程式檔案說明

### Q1.c - 單向移動球體系統

**功能**: 實作球體從左向右單向移動的動畫系統，支援開始、暫停、繼續控制

**系統特點**:
- 球體從螢幕左側移動到右側
- 可透過按鍵控制運動狀態
- 到達終點時觸發蜂鳴器提示
- 簡潔的狀態機設計

**按鍵功能表**:
| 按鍵 | 功能     | 說明                               |
| ---- | -------- | ---------------------------------- |
| 1    | 開始移動 | 重置球體到起始位置並開始移動       |
| 2    | 暫停移動 | 暫停球體運動（球體保持在當前位置） |
| 3    | 繼續移動 | 恢復球體運動（從暫停位置繼續）     |

**球體參數**:
- **半徑**: 4像素
- **移動距離**: 每次移動8像素（2倍半徑）
- **移動速度**: 每0.5秒移動一次
- **Y座標**: 固定在中間位置（32像素）
- **移動範圍**: X座標從4到123像素

**運動流程**:
```
起始位置(4,32) → 移動中 → 到達終點(123,32) → 蜂鳴器響 → 重置狀態
                ↑                           ↓
                └─────────── 按鍵控制 ──────────┘
```

**狀態機**:
```
未啟用 ──[按鍵1]──> 已啟用+執行中
                    ↓ [按鍵2]
              已啟用+暫停 ──[按鍵3]──> 已啟用+執行中
                    ↓
              [到達終點] → 蜂鳴器 → 未啟用
```

### Q2.c - 彈跳球體與目標方塊碰撞遊戲

**功能**: 實作控制球體移動並碰撞目標方塊的互動遊戲

**系統特點**:
- 球體可在8個方向上移動（水平、垂直、對角線）
- 兩個隨機位置的目標方塊（5x5像素）
- 碰撞檢測與方塊消除
- 邊界反彈機制
- 遊戲結束重置與重新開始

**按鍵功能表**:
| 按鍵 | 功能     | 說明                           |
| ---- | -------- | ------------------------------ |
| 4    | 向左移動 | 球體水平向左移動（3像素/次）   |
| 6    | 向右移動 | 球體水平向右移動（3像素/次）   |
| 3    | 右上移動 | 球體向右上45度移動（3像素/次） |
| 9    | 右下移動 | 球體向右下45度移動（3像素/次） |
| 1    | 左上移動 | 球體向左上45度移動（3像素/次） |
| 7    | 左下移動 | 球體向左下45度移動（3像素/次） |
| 5    | 停止移動 | 立即停止球體運動               |
| 8    | 重新產生 | 在所有方塊消失後產生新的方塊   |

**按鍵對應方向示意圖**:
```
        [1] [↑] [3]
         ↖  ↑  ↗
    [←] [4] [5] [6] [→]
         ↙  ↓  ↘
        [7] [↓] [9]
```

**遊戲物件參數**:
- **球體半徑**: 3像素
- **方塊尺寸**: 5x5像素
- **移動步進**: 每次移動3像素
- **方塊最小距離**: 兩個方塊之間至少20像素水平距離
- **球體初始位置**: (64, 60) - 螢幕中央底部

**碰撞檢測**:
- 使用AABB（軸對齊邊界框）碰撞檢測
- 將圓形視為正方形邊界框進行簡化檢測
- 檢測當前位置和下一位置的碰撞（防止穿透）

**邊界反彈**:
- **左邊界**: X座標 ≤ 半徑，反彈向右
- **右邊界**: X座標 ≥ 127-半徑，反彈向左
- **上邊界**: Y座標 ≤ 半徑，反彈向下
- **下邊界**: Y座標 ≥ 63-半徑，反彈向上

**遊戲流程**:
```
初始狀態 → 選擇移動方向 → 球體移動 → 碰撞檢測
                                    ↓
                              碰撞方塊 → 方塊消失
                                    ↓
                              所有方塊消失 → 重置球體
                                    ↓
                              按鍵8 → 重新產生方塊
```

### Q2-Lance.c - 彈跳球體遊戲（Lance版本）

**功能**: 與Q2.c功能相同，但為Lance版本的實作

**差異說明**:
- 基本遊戲機制相同
- 程式碼風格略有不同
- 部分實作細節可能有差異

## 🔍 技術重點

### 1. LCD圖形繪圖
- **圓形繪製**: 使用`draw_Circle()`函數繪製球體
- **像素繪製**: 使用`draw_Pixel()`函數繪製方塊
- **畫面清除**: 使用`clear_LCD()`或背景色覆蓋清除物件
- **座標系統**: (0,0)在左上角，X向右遞增，Y向下遞增

### 2. 動畫控制
- **雙緩衝技術**: 先清除舊位置，再繪製新位置
- **延遲控制**: 使用`CLK_SysTickDelay()`控制動畫速度
- **平滑移動**: 通過控制步進距離和延遲時間實現平滑動畫

### 3. 碰撞檢測演算法
- **AABB檢測**: Axis-Aligned Bounding Box碰撞檢測
- **邊界框計算**: 將圓形轉換為正方形邊界框
- **重疊判定**: 檢查兩個矩形邊界框是否重疊
- **預測碰撞**: 檢測當前位置和下一位置的碰撞

### 4. 隨機數產生
- **LCG演算法**: Linear Congruential Generator線性同餘生成器
- **種子來源**: 使用SysTick計數器值作為初始種子
- **範圍控制**: 使用模運算限制隨機數範圍
- **距離保證**: 確保兩個方塊之間有足夠距離

### 5. 狀態管理
- **運動狀態**: 追蹤球體是否正在移動
- **物件可見性**: 追蹤方塊是否已被消除
- **按鍵處理**: 使用按鍵釋放檢測避免重複觸發
- **遊戲狀態**: 管理遊戲進行、結束、重置等狀態

### 6. 邊界處理
- **邊界檢測**: 檢查球體是否超出螢幕範圍
- **反彈機制**: 改變移動方向實現反彈效果
- **位置限制**: 將座標限制在有效範圍內

## 🏗️ 程式架構

### Q1.c 架構
```
主程式迴圈
├── 按鍵掃描
├── 按鍵處理
│   ├── 按鍵1：開始（重置位置並啟動）
│   ├── 按鍵2：暫停
│   └── 按鍵3：繼續
└── 運動處理（如果已啟用且未暫停）
    ├── 延遲控制
    ├── 清除舊位置
    ├── 計算新位置
    ├── 邊界檢查
    ├── 繪製新位置
    └── 終點檢測與蜂鳴器
```

### Q2.c 架構
```
主程式迴圈
├── 按鍵掃描
├── 按鍵處理
│   ├── 方向按鍵（1,3,4,6,7,9）：設定移動方向
│   ├── 停止按鍵（5）：停止移動
│   └── 重新產生按鍵（8）：產生新方塊
└── 移動處理（如果正在移動）
    ├── 計算新位置
    ├── 邊界碰撞檢測與反彈
    ├── 方塊碰撞檢測（當前位置和下一位置）
    ├── 碰撞處理（清除方塊）
    ├── 遊戲結束檢查（所有方塊消失）
    ├── 清除舊位置
    ├── 重新繪製可見方塊
    ├── 更新位置
    ├── 繪製新位置
    └── 延遲控制
```

### 初始化流程
```c
SYS_Init();              // 系統初始化
init_LCD();              // LCD初始化
clear_LCD();             // 清除螢幕
OpenKeyPad();            // 按鍵初始化
BUZZ_Init();             // 蜂鳴器初始化（Q1）
或
GPIO_SetMode(PB, BIT11, GPIO_PMD_OUTPUT);  // 蜂鳴器初始化（Q2）
```

## 🎯 學習目標

1. **圖形繪圖技術**: 學習在嵌入式系統中繪製圓形和矩形圖形
2. **動畫實作**: 掌握動畫的基本原理和實作方法
3. **碰撞檢測**: 理解AABB碰撞檢測演算法及其應用
4. **狀態機設計**: 學習遊戲狀態管理和狀態轉換
5. **按鍵控制**: 掌握按鍵掃描、防彈跳和按鍵釋放檢測
6. **隨機數產生**: 了解嵌入式系統中的隨機數產生技術
7. **邊界處理**: 學習邊界檢測和反彈機制實作
8. **系統整合**: 整合多種硬體元件建立完整應用

## 🚀 擴展應用

### Q1 擴展
- 增加垂直移動或多方向移動
- 添加多個球體同時移動
- 增加速度控制功能
- 添加分數計時系統
- 實作軌跡顯示

### Q2 擴展
- 增加更多目標方塊
- 添加分數系統（消除方塊得分）
- 增加關卡系統（難度遞增）
- 添加障礙物
- 實作更精確的圓形-矩形碰撞檢測
- 增加不同類型的方塊（不同分數）
- 添加遊戲時間限制
- 實作高分記錄功能

### 硬體擴展
- 整合觸控螢幕控制
- 添加搖桿輸入
- 整合更多LED效果
- 增加音效系統
- 實作無線通訊對戰模式

## ⚠️ 注意事項

1. **硬體連接**: 確保LCD、按鍵矩陣和蜂鳴器正確連接
2. **座標系統**: 注意LCD座標系統（左上角為原點）
3. **碰撞檢測**: AABB檢測是簡化方法，並非精確的圓形-矩形碰撞
4. **畫面更新**: 注意繪圖順序，避免畫面殘影
5. **按鍵防彈跳**: 實作適當的按鍵釋放檢測避免重複觸發
6. **移動速度**: 調整延遲時間以獲得合適的動畫速度
7. **記憶體使用**: 注意變數類型和大小，避免溢出
8. **隨機性**: 確保隨機數種子有足夠變化性
9. **邊界處理**: 確保球體不會超出螢幕範圍
10. **狀態管理**: 正確管理遊戲狀態，避免狀態混亂

## 📚 相關技術

- **GPIO控制**: 數位I/O腳位設定和控制（蜂鳴器、按鍵）
- **LCD驅動**: LCD顯示器的初始化和控制
- **繪圖API**: 2D繪圖函數的使用（圓形、像素）
- **定時器**: 延遲和時序控制（`CLK_SysTickDelay`）
- **按鍵掃描**: 按鍵矩陣的掃描和處理
- **數學運算**: 座標計算、距離計算、碰撞檢測
- **演算法**: 隨機數產生、碰撞檢測、狀態機

## 📊 效能考量

- **繪圖效能**: 每次移動需要清除和重繪，注意繪圖開銷
- **碰撞檢測**: AABB檢測效率高，適合即時應用
- **CPU使用率**: 在停止狀態使用較短延遲降低CPU使用率
- **記憶體使用**: 使用適當的變數類型節省記憶體


